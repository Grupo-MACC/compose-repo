global
    log stdout format raw local0
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    tune.ssl.default-dh-param 2048
    ssl-default-bind-options no-tls-tickets
    ssl-default-server-options no-tls-tickets
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384
    ssl-default-server-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384

resolvers consul
    nameserver consul consul:8600
    nameserver docker 127.0.0.11:53
    accepted_payload_size 8192
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      30s
    hold refused    30s
    hold nx         30s
    hold timeout    30s
    hold valid      10s

defaults
    log     global
    mode    http
    option  httplog
    timeout connect 5s
    timeout client  10s
    timeout server  10s

# Entrada principal del API Gateway
frontend https_front
    bind *:443 ssl crt /usr/local/etc/haproxy/certs/haproxy.pem alpn h2,http/1.1
    mode http
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-For %[src]
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-Frame-Options "SAMEORIGIN"

    # Reglas de enrutamiento por prefijo de URL
    acl is_order  path_beg /order
    acl is_piece  path_beg /piece
    acl is_machine path_beg /machine
    acl is_delivery path_beg /delivery
    acl is_payment path_beg /payment
    acl is_auth path_beg /auth
    acl is_user path_beg /user
    acl is_logs path_beg /logs
    acl is_honeypot path_beg /honeypot

    use_backend order_service   if is_order
    use_backend order_service   if is_piece
    use_backend machine_service if is_machine
    use_backend delivery_service if is_delivery
    use_backend payment_service if is_payment
    use_backend auth_service if is_auth
    use_backend auth_service if is_user
    use_backend logs_service if is_logs
    use_backend honeypot_service if is_honeypot

# Backend para el servicio 'order' - Using Docker DNS (Internal HTTP)
backend order_service
    #http-request replace-path ^/order(/.*)? \1
    server order1 order:5000 check inter 5s downinter 1s fall 2 rise 3 fastinter 500
    
# Backend para el servicio 'machine' - Using Docker DNS (Internal HTTP)
backend machine_service
    balance roundrobin
    server machineA machine-a:5001 check inter 5s downinter 1s fall 2 rise 3 fastinter 500
    server machineB machine-b:5001 check inter 5s downinter 1s fall 2 rise 3 fastinter 500
    
# Backend para el servicio 'delivery' - Using Docker DNS (Internal HTTP)
backend delivery_service
    server delivery1 delivery:5002 check inter 5s downinter 1s fall 2 rise 3 fastinter 500

# Backend para el servicio 'payment' - Using Docker DNS (Internal HTTP)
backend payment_service
    server payment2 payment:5003 check inter 5s downinter 1s fall 2 rise 3 fastinter 500

# Backend para el servicio 'auth' - Using Docker DNS for dynamic discovery with replicas (Internal HTTP)
backend auth_service
    balance roundrobin
    server-template auth 4 auth:5004 resolvers consul init-addr libc,none resolve-prefer ipv4 check inter 5s downinter 1s fall 2 rise 3 fastinter 500

# Backend para el servicio 'honeypot' - Using Docker DNS (Internal HTTP)
backend honeypot_service
    server honeypot honeypot:5010 check inter 5s downinter 1s fall 2 rise 3 fastinter 500

# Backend del logger (deshabilitado - servicio no desplegado)
backend logs_service
    server logs logger:6000 check inter 5s downinter 1s fall 2 rise 3 fastinter 500

# Backend por defecto (si la ruta no coincide con ninguna)
backend default_service
    errorfile 503 /usr/local/etc/haproxy/errors/503.http

listen stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 5s
    stats auth admin:admin   # usuario y contrase√±a
