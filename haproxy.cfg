global
    log stdout format raw local0

    # TLS hardening (frontend)
    tune.ssl.default-dh-param 2048
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384

    # TLS hardening (backend)
    ssl-default-server-options no-tls-tickets
    ssl-default-server-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384

resolvers consul
    nameserver consul consul:8600
    nameserver docker 127.0.0.11:53
    accepted_payload_size 8192
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      30s
    hold refused    30s
    hold nx         30s
    hold timeout    30s
    hold valid      10s

defaults
    log     global
    mode    http
    option  httplog
    option  http-server-close
    option  forwardfor

    timeout connect 5s
    timeout client  30s
    timeout server  30s

# ------------------------------------------------------------
# 80 -> 443 (redirigir a HTTPS)
# Si NO quieres exponer HTTP, quita el puerto 80 del docker-compose
# ------------------------------------------------------------
frontend http_front
    bind *:80
    mode http
    redirect scheme https code 301

# ------------------------------------------------------------
# Entrada principal del API Gateway (HTTPS)
# ------------------------------------------------------------
frontend https_front
    bind *:443 ssl crt /usr/local/etc/haproxy/certs/haproxy.pem alpn h2,http/1.1
    mode http

    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Port %[dst_port]

    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-Frame-Options "SAMEORIGIN"

    # Reglas de enrutamiento por prefijo de URL
    acl is_order     path_beg /order
    acl is_piece     path_beg /piece
    acl is_machine   path_beg /machine
    acl is_delivery  path_beg /delivery
    acl is_payment   path_beg /payment
    acl is_auth      path_beg /auth
    acl is_user      path_beg /user
    acl is_warehouse path_beg /warehouse
    acl is_logs      path_beg /logs

    use_backend order_service     if is_order
    use_backend order_service     if is_piece
    use_backend machine_service   if is_machine
    use_backend delivery_service  if is_delivery
    use_backend payment_service   if is_payment
    use_backend auth_service      if is_auth
    use_backend auth_service      if is_user
    use_backend warehouse_service if is_warehouse
    use_backend logs_service      if is_logs

    default_backend default_service

# ------------------------------------------------------------
# Backends (HAProxy -> microservicios por HTTPS)
# IMPORTANTE: cada "server" va en UNA sola l√≠nea (sin '\')
# ------------------------------------------------------------
backend order_service
    server order1 order:5000 ssl verify required ca-file /usr/local/etc/haproxy/certs/ca.pem check check-ssl inter 5s downinter 1s fall 2 rise 3 fastinter 500

backend machine_service
    balance roundrobin
    server-template machineA 10 machine-a:5001 resolvers consul init-addr libc,none resolve-prefer ipv4 ssl verify required ca-file /usr/local/etc/haproxy/certs/ca.pem check check-ssl
    server-template machineB 10 machine-b:5001 resolvers consul init-addr libc,none resolve-prefer ipv4 ssl verify required ca-file /usr/local/etc/haproxy/certs/ca.pem check check-ssl

backend delivery_service
    server delivery1 delivery:5002 ssl verify required ca-file /usr/local/etc/haproxy/certs/ca.pem check check-ssl inter 5s downinter 1s fall 2 rise 3 fastinter 500

backend payment_service
    server payment1 payment:5003 ssl verify required ca-file /usr/local/etc/haproxy/certs/ca.pem check check-ssl inter 5s downinter 1s fall 2 rise 3 fastinter 500

backend warehouse_service
    server warehouse1 warehouse:5005 ssl verify required ca-file /usr/local/etc/haproxy/certs/ca.pem check check-ssl inter 5s downinter 1s fall 2 rise 3 fastinter 500

backend auth_service
    balance roundrobin
    server-template auth 4 auth:5004 resolvers consul init-addr libc,none resolve-prefer ipv4 ssl verify required ca-file /usr/local/etc/haproxy/certs/ca.pem check check-ssl inter 5s downinter 1s fall 2 rise 3 fastinter 500

# Logger (lo dejas como estaba: HTTP interno)
backend logs_service
    server logs logger:6000 check inter 5s downinter 1s fall 2 rise 3 fastinter 500

backend default_service
    errorfile 503 /usr/local/etc/haproxy/errors/503.http

listen stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 5s
    stats auth admin:admin
