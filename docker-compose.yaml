services:

#region auth-db
  auth-db:
    image: postgres:15-alpine
    container_name: auth-db
    environment:
      - POSTGRES_USER=auth_user
      - POSTGRES_PASSWORD=auth_password
      - POSTGRES_DB=auth_db
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    networks:
      - n1
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

#region consul
  consul:
    image: consul:1.15
    container_name: consul
    hostname: consul
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    environment:
      - CONSUL_BIND_INTERFACE=eth0
    command: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0 -bind=0.0.0.0
    networks:
      - n1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "consul", "version"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

#region rabbitmq
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    hostname: rabbitmq
    ports:
      - "5671:5671"
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - ./certs:/certs:ro
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/conf.d/20-ssl.conf:ro
    networks:
      - n1
    depends_on:
      consul:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

#region auth 
  auth:
    build:
      context: auth
      dockerfile: Dockerfile
    networks:
      - n1
    restart: on-failure
    environment:
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_NAME=auth
      - SERVICE_PORT=5004
      - SQLALCHEMY_DATABASE_URL=postgresql+asyncpg://auth_user:auth_password@auth-db:5432/auth_db
      - RABBITMQ_USE_TLS=1
      - RABBITMQ_PORT=5671
      - RABBITMQ_TLS_CA_FILE=/certs/ca.pem
    depends_on:
      rabbitmq:
        condition: service_healthy
      consul:
        condition: service_healthy
      auth-db:
        condition: service_healthy
    volumes:
      - ./certs/auth/auth-cert.pem:/certs/auth/auth-cert.pem:ro
      - ./certs/auth/auth-key.pem:/certs/auth/auth-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro
      - auth-keys:/home/pyuser/keys
    deploy:
      replicas: 4

#region order
  order:
    build: 
      context: Order
      dockerfile: Dockerfile
    container_name: order
    ports:
      - "5000:5000"
    networks:
      - n1
    restart: "no"
    environment:
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_NAME=order
      - SERVICE_PORT=5000
      - SERVICE_ID=order-1
      - RABBITMQ_USE_TLS=1
      - RABBITMQ_PORT=5671
      - RABBITMQ_TLS_CA_FILE=/certs/ca.pem
    depends_on:
      rabbitmq:
        condition: service_healthy
      consul:
        condition: service_healthy
    volumes:
      - ./certs/order/order-cert.pem:/certs/order/order-cert.pem:ro
      - ./certs/order/order-key.pem:/certs/order/order-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro 

#region machine
  machine-a:
    build: 
      context: Machine
      dockerfile: Dockerfile
    # container_name: machine
    ports:
      - "5001:5001"
    networks:
      - n1
    restart: "no"
    environment:
      - SERVICE_NAME=machine-a
      - SERVICE_ID=machine-a-1
      - SERVICE_PORT=5001
      - MACHINE_PIECE_TYPE=A
      - BLACKLIST_DATABASE_URL=postgresql+asyncpg://blacklist:blacklist@blacklist-db:5432/blacklist
      - RABBITMQ_USE_TLS=1
      - RABBITMQ_PORT=5671
      - RABBITMQ_TLS_CA_FILE=/certs/ca.pem
    depends_on:
      rabbitmq:
        condition: service_healthy
      consul:
        condition: service_healthy
      blacklist-db:
        condition: service_healthy
    volumes:
      - ./certs/machine/machine-cert.pem:/certs/machine/machine-cert.pem:ro
      - ./certs/machine/machine-key.pem:/certs/machine/machine-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro
  
  machine-b:
    build: 
      context: Machine
      dockerfile: Dockerfile
    # container_name: machine
    ports:
      - "5006:5001"
    networks:
      - n1
    restart: "no"
    environment:
      - SERVICE_NAME=machine-b
      - SERVICE_ID=machine-b-1
      - SERVICE_PORT=5001
      - MACHINE_PIECE_TYPE=B
      - BLACKLIST_DATABASE_URL=postgresql+asyncpg://blacklist:blacklist@blacklist-db:5432/blacklist
      - RABBITMQ_USE_TLS=1
      - RABBITMQ_PORT=5671
      - RABBITMQ_TLS_CA_FILE=/certs/ca.pem
    depends_on:
      rabbitmq:
        condition: service_healthy
      consul:
        condition: service_healthy
      blacklist-db:
        condition: service_healthy
    volumes:
      - ./certs/machine/machine-cert.pem:/certs/machine/machine-cert.pem:ro
      - ./certs/machine/machine-key.pem:/certs/machine/machine-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro

#region blacklist-db
  blacklist-db:
    # BD ligera local para simular Aurora/RDS (PostgreSQL).
    image: postgres:15-alpine
    container_name: blacklist-db
    environment:
      # Credenciales simples para entorno local.
      - POSTGRES_USER=blacklist
      - POSTGRES_PASSWORD=blacklist
      - POSTGRES_DB=blacklist
    volumes:
      # Persistencia (si reinicias, no pierdes la blacklist).
      - blacklist-db-data:/var/lib/postgresql/data
    networks:
      - n1
    healthcheck:
      # Healthcheck est√°ndar de Postgres.
      test: ["CMD-SHELL", "pg_isready -U blacklist -d blacklist"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
#endregion


#region delivery
  delivery:
    build:
      context: Delivery
      dockerfile: Dockerfile
    container_name: delivery
    ports:
      - "5002:5002"
    networks:
      - n1
    restart: "no"
    environment:
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_NAME=delivery
      - SERVICE_PORT=5002
      - SERVICE_ID=delivery-1
      - RABBITMQ_USE_TLS=1
      - RABBITMQ_PORT=5671
      - RABBITMQ_TLS_CA_FILE=/certs/ca.pem
    depends_on:
      rabbitmq:
        condition: service_healthy
      consul:
        condition: service_healthy
    volumes:
      - ./certs/delivery/delivery-cert.pem:/certs/delivery/delivery-cert.pem:ro
      - ./certs/delivery/delivery-key.pem:/certs/delivery/delivery-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro

#region payment  
  payment:
    build:
      context: Payment
      dockerfile: Dockerfile
    container_name: payment
    ports:
      - "5003:5003"
    networks:
      - n1
    restart: "no"
    environment:
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_NAME=payment
      - SERVICE_PORT=5003
      - SERVICE_ID=payment-1
      - RABBITMQ_USE_TLS=1
      - RABBITMQ_PORT=5671
      - RABBITMQ_TLS_CA_FILE=/certs/ca.pem
    depends_on:
      rabbitmq:
        condition: service_healthy
      consul:
        condition: service_healthy
    volumes:
      - ./certs/payment/payment-cert.pem:/certs/payment/payment-cert.pem:ro
      - ./certs/payment/payment-key.pem:/certs/payment/payment-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro

#region api-gateway
  api-gateway:
    image: haproxy:2.9
    container_name: api_gateway
    ports:
      - "80:80"
      - "443:443"
      - "8404:8404"
    networks:
      n1:
        aliases:
          - grupo2
    extra_hosts:
      - "grupo2:127.0.0.1"
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ./certs/haproxy.pem:/usr/local/etc/haproxy/certs/haproxy.pem:ro
      - ./certs/haproxy-client.pem:/usr/local/etc/haproxy/certs/haproxy-client.pem:ro
      - ./certs/ca.pem:/usr/local/etc/haproxy/certs/ca.pem:ro
    depends_on:
      consul:
        condition: service_healthy
      order:
        condition: service_started
      machine-a:
        condition: service_started
      machine-b:
        condition: service_started
      delivery:
        condition: service_started
      payment:
        condition: service_started
    restart: unless-stopped

#region warehouse
  warehouse:
    build:
      context: Warehouse
      dockerfile: Dockerfile
    container_name: warehouse
    ports:
      - "5005:5005"
    networks:
      - n1
    restart: "no"
    environment:
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_NAME=warehouse
      - SERVICE_PORT=5005
      - SERVICE_ID=warehouse-1
      - RABBITMQ_USE_TLS=1
      - RABBITMQ_PORT=5671
      - RABBITMQ_TLS_CA_FILE=/certs/ca.pem
    depends_on:
      rabbitmq:
        condition: service_healthy
      consul:
        condition: service_healthy
    volumes:
      - ./certs/warehouse/warehouse-cert.pem:/certs/warehouse/warehouse-cert.pem:ro
      - ./certs/warehouse/warehouse-key.pem:/certs/warehouse/warehouse-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro

#region influxdb
  influxdb:
    image: influxdb:2
    container_name: influxdb
    ports:
      - "8086:8086"
    networks:
      - n1
    volumes:
      - influxdb-data:/var/lib/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123
      - DOCKER_INFLUXDB_INIT_ORG=my-org
      - DOCKER_INFLUXDB_INIT_BUCKET=factory_logs
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=MY_CUSTOM_TOKEN_123456
      - DOCKER_INFLUXDB_INIT_BUCKETS=factory_errors,factory_monitoring,factory_debug,factory_logs

  influxdb-init:
    image: influxdb:2
    depends_on:
      - influxdb
    volumes:
      - ./init-influxdb.sh:/init-influxdb.sh:ro
    entrypoint: /init-influxdb.sh
    environment:
      - INFLUX_HOST=http://influxdb:8086
      - INFLUX_ORG=my-org
      - INFLUX_TOKEN=MY_CUSTOM_TOKEN_123456
    networks:
      - n1
    restart: "no"

#region telegraf  
  telegraf:
    image: telegraf:latest
    container_name: telegraf
    networks:
      - n1
    volumes:
      - ./telegraf.conf:/etc/telegraf/telegraf.conf
    depends_on:
      rabbitmq:
        condition: service_healthy

#region logger
  logger:
    build:
      context: ./logger
      dockerfile: Dockerfile
    container_name: logger
    ports:
      - "6000:6000"
    networks:
      - n1
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

networks:
  n1:
    driver: bridge
  
volumes:
  influxdb-data:
  auth-keys:
  auth-db-data:
  blacklist-db-data: