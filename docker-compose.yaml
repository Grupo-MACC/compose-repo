services:

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    hostname: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - ./certs:/certs:ro
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/conf.d/20-ssl.conf:ro
    networks:
      - n1
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  
  auth:
    build:
      context: auth
      dockerfile: Dockerfile
    container_name: auth
    ports:
      - "5004:5004"
    networks:
      - n1
    restart: "no"
    depends_on:
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./certs/auth/auth-cert.pem:/certs/auth/auth-cert.pem:ro
      - ./certs/auth/auth-key.pem:/certs/auth/auth-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro

  order:
    build: 
      context: Order
      dockerfile: Dockerfile
    container_name: order
    ports:
      - "5000:5000"
    networks:
      - n1
    restart: "no"
    depends_on:
      rabbitmq:
        condition: service_healthy 
    volumes:
      - ./certs/order/order-cert.pem:/certs/order/order-cert.pem:ro
      - ./certs/order/order-key.pem:/certs/order/order-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro 

  machine:
    build: 
      context: Machine
      dockerfile: Dockerfile
    container_name: machine
    ports:
      - "5001:5001"
    networks:
      - n1
    restart: "no"
    depends_on:
      rabbitmq:
        condition: service_healthy 
    volumes:
      - ./certs/machine/machine-cert.pem:/certs/machine/machine-cert.pem:ro
      - ./certs/machine/machine-key.pem:/certs/machine/machine-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro

  delivery:
    build:
      context: Delivery
      dockerfile: Dockerfile
    container_name: delivery
    ports:
      - "5002:5002"
    networks:
      - n1
    restart: "no"
    depends_on:
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./certs/delivery/delivery-cert.pem:/certs/delivery/delivery-cert.pem:ro
      - ./certs/delivery/delivery-key.pem:/certs/delivery/delivery-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro
  
  payment:
    build:
      context: Payment
      dockerfile: Dockerfile
    container_name: payment
    ports:
      - "5003:5003"
    networks:
      - n1
    restart: "no"
    depends_on:
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./certs/payment/payment-cert.pem:/certs/payment/payment-cert.pem:ro
      - ./certs/payment/payment-key.pem:/certs/payment/payment-key.pem:ro
      - ./certs/ca.pem:/certs/ca.pem:ro

  api-gateway:
    image: haproxy:2.9
    container_name: api_gateway
    ports:
      - "80:80"
      - "443:443"
      - "8404:8404"
    networks:
      n1:
        aliases:
          - grupo2
    extra_hosts:
      - "grupo2:127.0.0.1"
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ./certs/haproxy.pem:/usr/local/etc/haproxy/certs/haproxy.pem:ro
      - ./certs/haproxy-client.pem:/usr/local/etc/haproxy/certs/haproxy-client.pem:ro
      - ./certs/ca.pem:/usr/local/etc/haproxy/certs/ca.pem:ro
    depends_on:
      - order
      - machine
      - delivery
      - payment
    restart: unless-stopped

networks:
  n1:
    driver: bridge